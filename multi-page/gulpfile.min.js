var gulp = require('gulp'),
    jade = require('gulp-jade'),
    stylus = require('gulp-stylus'),
    rename = require('gulp-rename'),
    data = require('gulp-data'),
    minifyCss = require('gulp-minify-css'),
    nib = require('nib'),
    glob = require('glob'),
    webpack = require('webpack'),
    fse = require('fs-extra'),
    path = require('path');


var Path = {
  libs: {
    css: path.join(__dirname, 'src/libs/css/index.styl'),
    js: path.join(__dirname, 'src/libs/js/index.js')
  },
  common: {
    css: path.join(__dirname, 'src/common/css/index.styl'),
    js: path.join(__dirname, 'src/common/js/index.js')
  },
  pages: {
    html: path.join(__dirname, 'src/pages/*/index.jade'),
    css: path.join(__dirname, 'src/pages/*/index.styl'),
    js: path.join(__dirname, 'src/pages/*/index.js')
  },
  resources: path.join(__dirname, 'src/resources/'),
  dest: {
    html: path.join(__dirname, 'dist/'),
    css: path.join(__dirname, 'dist/static/css/'),
    js: path.join(__dirname, 'dist/static/js/'),
    resources: path.join(__dirname, 'dist/static/resources/')
  }
};


// Compile libs
gulp.task('libs-css', function() {
  return gulp.src(Path.libs.css)
              .pipe(stylus())
              .pipe(minifyCss())
              .pipe(rename('libs.css'))
              .pipe(gulp.dest(Path.dest.css));
});

gulp.task('libs', ['libs-css']);


// Compile common
gulp.task('common-css', function() {
  return gulp.src(Path.common.css)
              .pipe(stylus({
                use: [nib()],
                import: ['nib']
              }))
              .pipe(minifyCss())
              .pipe(rename('common.css'))
              .pipe(gulp.dest(Path.dest.css));
});

gulp.task('common', ['common-css']);


// Compile pages
gulp.task('pages-html', function() {
  return gulp.src(Path.pages.html)
              .pipe(data(function(f) {
                return {pageName: path.basename(path.dirname(f.path))};
              }))
              .pipe(jade({
                pretty: true
              }))
              .pipe(rename(function(filePath) {
                filePath.basename = filePath.dirname;
                filePath.dirname = '';
              }))
              .pipe(gulp.dest(Path.dest.html));
});

gulp.task('pages-css', function() {
  return gulp.src(Path.pages.css)
              .pipe(stylus({
                use: [nib()],
                import: ['nib']
              }))
              .pipe(minifyCss())
              .pipe(rename(function(filePath) {
                filePath.basename = filePath.dirname;
                filePath.dirname = '';
              }))
              .pipe(gulp.dest(Path.dest.css));
});

gulp.task('pages', ['pages-html', 'pages-css']);


gulp.task('js', function(callback) {
  glob(Path.pages.js, function(err, files) {
    if (err) return callback(err);

    var entry = {};

    files.reduce(function(pre, cur){
      var name = path.basename(path.dirname(cur));
      return entry[name] = cur;
    }, entry);

    entry['libs'] = Path.libs.js;
    entry['common'] = Path.common.js;

    webpack({
      entry: entry,
      output: {
        path: Path.dest.js,
        filename: '[name].js'
      },
      plugins: [
        new webpack.optimize.UglifyJsPlugin({
          compress: {
              warnings: false
          }
        })
      ]
    }).run(function(err, stats) {
      if (err) return callback(err);

      console.log(stats.toString({
        colors: true,
        chunkModules: false
      }));
      callback();
    });
  });
});


// copy the resources
gulp.task('resources', function(callback) {
  fse.copy(Path.resources, Path.dest.resources, function(err) {
    if (err) return callback(err);
    callback();
  });
});


gulp.task('default', ['libs', 'common', 'pages', 'js', 'resources']);
